<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="styles/bootstrap.css" type="text/css"/>
    <link rel="stylesheet" href="styles/bootstrap-social.css" type="text/css"/>
    <link rel="stylesheet" href="styles/font-awesome.css" type="text/css"/>
    <link rel="stylesheet" href="styles/style.css" type="text/css"/>
    <script type="text/javascript" src="scripts/jquery/jquery-2.1.4.js"></script>
    <script type="text/javascript" src="scripts/jquery.leanModal.min.js"></script>
    <script src="scripts/oauth.js"></script>
    <script type="text/javascript">
        OAuth.initialize('DONT COMMIT');

        $(document).ready(function() {
            $("#modalTrigger").leanModal();
        });
        
        function authEmail() {
            // surely form post instead, to auth service!?
        }
        
        function authTwitter() {
            //Using popup
            OAuth.popup('twitter').done(function(result) {
                //use result.access_token in your API request 
                //or use result.get|post|put|del|patch|me methods (see below)
                result.get('/1.1/account/verify_credentials.json?include_email=true').done(function(data) {
                    processUserData(data);
                })
            })
            .fail(function (err) {
                //handle error with err
                console.error("ERROR : " + err);
            });
        }
        
        function authFacebook() {
            OAuth.popup('facebook').done(function(result) {
                result.me().done(function(data) {
                    processUserData(data);
                })
            })
        }
        
        function authGoogle() {
            OAuth.popup('google').done(function(result) {
                result.me().done(function(data) {
                    processUserData(data);
                })
                
                /*
                result.get('/1.1/account/verify_credentials.json').done(function(data) {
                    console.log(data);
                    alert('Hello ' + data.name);
                })
                */
                
                //console.log(result)
                // do some stuff with result
            })
        }
        
        function authUser(uniqueUserID, name, email) {
            // check if this user is already in the db
            if(!userExists(uniqueUserID)) {
                newUser(uniqueUserID, name, email);
            }
        }
        
        function userExists(uniqueUserID) {
            // do we have a record in the DB? true/false
            // TODO GET request for user details
            return false;
        }
        
        function newUser(uniqueUserID, name, email) {
            // doesnt exist in our database, create
            // store the auth source too, google or twitter?
            console.log("Creating new user! ID: " + uniqueUserID + " Name: " + name + " Email: " + email);
            // TODO POST request for setting up new user
        }
        
        function processUserData(data) {
            
            $('#lean_overlay').hide();
            $('#modalTrigger').hide();
            $('#authBox').hide();
            
            // do something with `data`, e.g. print data.name
            //console.log(data);
            //alert('Hello ' + data.name);
            
            $('#username').text('Username; ' + data.name);
            
            authUser(data.id, data.name, data.email);
        }
	</script>
</head>
<body>
	<h1>Auth Testing</h1>
    
    <!--
    <button onclick="authTwitter()">Auth via Twitter</button>
    <button onclick="authFacebook()">Auth via Facebook</button>
    <button onclick="authGoogle()">Auth via Google</button>
    -->
    <a id="modalTrigger" href="#authBox" class="btn">Click here to Login or register</a>
    
    <div id="authBox" class="popupContainer" style="display: none">
        <a class="btn btn-block btn-social btn-twitter" onclick="authTwitter()">
            <span class="fa fa-twitter"></span> Sign in with Twitter
        </a>
        <a class="btn btn-block btn-social btn-facebook" onclick="authFacebook()">
            <span class="fa fa-facebook"></span> Sign in with Facebook
        </a>
        <a class="btn btn-block btn-social btn-google" onclick="authGoogle()">
            <span class="fa fa-google"></span> Sign in with Google
        </a>
        <!--
        we can come back to this, we don't need it for go live and we should encourage open auth
        <br><hr>
        <div>
            Email:<input type="text" name="user">
            Password:<input type="password" name="password">
            <button onclick="authEmail()">OK</button>
        </div>
        -->
    </div>
    
    <!-- do we really need to return the name to screen? -->
    <div id="username"></div>
    
    <!--
    <a class="btn btn-social-icon btn-twitter">
        <span class="fa fa-twitter"></span>
    </a>
    -->
    
</body>
</html>